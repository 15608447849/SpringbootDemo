import org.springframework.boot.gradle.plugin.SpringBootPlugin

plugins {
    id 'org.springframework.boot' version '3.5.3' apply false
    id 'io.spring.dependency-management' version '1.1.7' apply false
}

allprojects {
    repositories {
        maven{ url = 'https://maven.aliyun.com/repository/public'}
        maven{ url = 'https://maven.aliyun.com/repository/central'}
        maven{ url = 'https://maven.aliyun.com/repository/google'}
        maven{ url = 'https://maven.aliyun.com/repository/apache-snapshots'}
        maven { url = "https://jitpack.io" }
        mavenCentral()
        google()
    }
}



subprojects { sub ->
    // 内置
    apply plugin: 'java'
    apply plugin: 'java-library'
    apply plugin: 'groovy'


    group = 'com.demo'
    version = '0.0.1-SNAPSHOT'

    java {
        sourceCompatibility = JavaVersion.VERSION_22
        targetCompatibility = JavaVersion.VERSION_22
    }


    compileJava {
        [compileJava]*.options*.encoding = 'UTF-8'
    }

    tasks.withType(JavaCompile).configureEach {
        options.encoding = "UTF-8"
        options.compilerArgs << "-Xlint:unchecked" << "-Xlint:deprecation"
    }
    gradle.projectsEvaluated {
        tasks.withType(JavaCompile).configureEach {
            options.compilerArgs << "-Xlint:-deprecation"
        }
    }

    tasks.withType(Javadoc).configureEach {
        failOnError = false
        options.addStringOption('Xdoclint:none', '-quiet')
        options.addStringOption('encoding', 'UTF-8')
        options.addStringOption('charSet', 'UTF-8')
        options.addStringOption('-Xlint', 'unchecked')
        options.addStringOption('-Xlint', 'deprecation')
        options.addStringOption('deprecation', 'true')

    }

    tasks.register('sourcesJar', Jar) {
        archiveClassifier = 'sources'
        from sourceSets.main.allSource
    }

    tasks.register('javadocJar', Jar) {
        archiveClassifier = 'javadoc'
        from javadoc
    }

    java {
        withJavadocJar()
        withSourcesJar()
    }

    configurations {
        configureEach {
            // 依赖缓存时效
            resolutionStrategy.cacheDynamicVersionsFor 0, 'seconds'
            resolutionStrategy.cacheChangingModulesFor 0, 'seconds'
        }
    }

    // 用于移除logback日志依赖
//    configurations.configureEach {
//        exclude group: 'ch.qos.logback', module: 'logback-classic'
//        exclude group: 'org.apache.logging.log4j', module: 'log4j-to-slf4j'
//    }


    if (sub.name == 'mydep') {
        return
    }

    // spring boot 部分

    apply plugin: 'org.springframework.boot'
    apply plugin: 'io.spring.dependency-management'


    // bom版本查询:
    // https://spring.io/projects/spring-cloud
    // https://spring.io/projects/spring-cloud-alibaba
    // https://sca.aliyun.com/docs/2023/overview/version-explain/

    // https://www.cnblogs.com/zhulw/articles/18868321 # Spring Boot 与 Spring Cloud 的版本兼容策略与 Maven BOM 管理全解析

    dependencyManagement {
        imports {
            mavenBom(SpringBootPlugin.BOM_COORDINATES)

//            mavenBom "org.springframework.cloud:spring-cloud-dependencies:2024.0.0"
//            mavenBom "com.alibaba.cloud:spring-cloud-alibaba-dependencies:2024.0.0.0"


            //   spring-cloud = 2025.0.x   Spring Boot = 3.5.x
            mavenBom org.springframework.boot.gradle.plugin.SpringBootPlugin.BOM_COORDINATES
            mavenBom 'org.springframework.cloud:spring-cloud-dependencies:2025.0.0'
//            mavenBom 'com.alibaba.cloud:spring-cloud-alibaba-dependencies:2023.0.1.3'
            mavenBom 'com.alibaba.cloud:spring-cloud-alibaba-dependencies:2023.0.3.4'
//            mavenBom 'com.alibaba.cloud:spring-cloud-alibaba-dependencies:2025.0.0.0'

        }
    }



    dependencies {
//        // nacos 服务注册发现
//        implementation ('com.alibaba.cloud:spring-cloud-starter-alibaba-nacos-discovery') {
//            exclude group: 'ch.qos.logback', module: 'logback-classic'
//        }
//        // nacos 配置中心
//        implementation ('com.alibaba.cloud:spring-cloud-starter-alibaba-nacos-config') {
//            exclude group: 'ch.qos.logback', module: 'logback-classic'
//        }

        // boot核心
//        implementation('org.springframework.boot:spring-boot-starter') {
//            // 移除logback
//            exclude group: 'org.springframework.boot', module: 'spring-boot-starter-logging'
//        }
//        // 使用log4j2
//        implementation 'org.springframework.boot:spring-boot-starter-log4j2'


        // boot核心 含logback日志依赖
        implementation 'org.springframework.boot:spring-boot-starter'

        // web容器
        implementation 'org.springframework.boot:spring-boot-starter-web'
        // aop切面
        implementation 'org.springframework.boot:spring-boot-starter-aop'

        implementation 'org.projectlombok:lombok:1.18.30'
        annotationProcessor 'org.projectlombok:lombok:1.18.30'


        // 测试类
        testImplementation 'org.springframework.boot:spring-boot-starter-test'
    }


    bootJar {
        zip64 = true
        version = new Date().format("yyyyMMddHHmmssSSS")

        def archiveFileName = bootJar.archiveFileName.get()
        def jar = file("${layout.buildDirectory.asFile.get()}/libs/${archiveFileName}")
        def storage = file("${project.rootDir}/${COMPLETE_JAR_DIR}/${archiveFileName}")
        def subBuildDir = project.rootProject.subprojects
        doLast {
            copy {
                println("✅ 打包完成: ${archiveFileName} \t时间: ${new Date().format("yyyy-MM-dd HH:mm:ss:SSS")}")
                from jar
                into storage.parent
                println("✅ 完成复制: ${archiveFileName} \t 大小: ${jar.length()}b \n原位置: ${jar}\n移动到: ${storage}")
            }
        }.doLast {
            subBuildDir.each { subProject ->
                def buildDir = file("${subProject.projectDir}/build")
                println "✅ 已清理模块 build 目录: ${buildDir} delete = ${delete buildDir}"
            }
        }
    }
}




